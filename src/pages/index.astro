---
import Layout from '~/layouts/PageLayout.astro';
import { getCollection } from 'astro:content';

import Hero from '~/components/widgets/Hero.astro';
import Features2 from '~/components/widgets/Features2.astro';
import Content from '~/components/widgets/Content.astro';
import Steps from '~/components/widgets/Steps.astro';
import Testimonials from '~/components/widgets/Testimonials.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import Stats from '~/components/widgets/Stats.astro';

const metadata = {
  title: 'Retraites spirituelles en Suisse — Foyer de Charité Dents-du-Midi, Bex',
  ignoreTitleTemplate: true,
  description: 'Retraites spirituelles en Suisse romande de 1 à 6 jours face aux Alpes. Silence, enseignements, accompagnement spirituel. Le seul Foyer de Charité en Suisse, à Bex (VD).',
};

// --- Prochaines retraites (dynamique depuis la collection events) ---
const today = new Date().toISOString().split('T')[0]; // "YYYY-MM-DD"
const allEvents = await getCollection('event');
const upcomingEvents = allEvents
  .filter((e) => e.data.dateStart >= today)
  .sort((a, b) => a.data.dateStart.localeCompare(b.data.dateStart))
  .slice(0, 3);

const formatDate = (dateStr: string) => {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('fr-CH', { day: 'numeric', month: 'long' });
};

const formatDateRange = (start: string, end?: string) => {
  if (!end) return formatDate(start);
  const s = new Date(start + 'T12:00:00');
  const e = new Date(end + 'T12:00:00');
  if (s.getMonth() === e.getMonth()) {
    return `${s.getDate()}-${e.toLocaleDateString('fr-CH', { day: 'numeric', month: 'long' })}`;
  }
  return `${formatDate(start)} - ${formatDate(end)}`;
};

const stepsItems = [
  ...upcomingEvents.map((event) => ({
    title: `${formatDateRange(event.data.dateStart, event.data.dateEnd)} — <span class="font-medium">«${event.data.title}»</span>`,
    description: `${event.data.preacher}${event.data.variant ? ` · ${event.data.variant}` : ''}${event.data.price ? ` · ${event.data.price}` : ''}`,
    icon: 'tabler:calendar' as const,
  })),
  {
    title: 'Voir tout le programme',
    description: '',
    icon: 'tabler:arrow-right' as const,
  },
];

// --- Témoignages (dynamique depuis la collection testimonials) ---
const allTestimonials = await getCollection('testimonial');
const shuffled = [...allTestimonials].sort(() => Math.random() - 0.5);
const selectedTestimonials = shuffled.slice(0, 6).map((t) => ({
  testimonial: t.data.quote,
  name: t.data.name,
  job: t.data.retreatType || 'Retraitant(e)',
}));
---

<Layout metadata={metadata}>
  <!-- Hero : Vue Dents-du-Midi + Accroche -->
  <Hero
    actions={[
      {
        variant: 'primary',
        text: "S'inscrire à une retraite",
        href: '/contact/inscription',
        icon: 'tabler:arrow-right',
      },
      {
        text: 'Voir le programme 2026',
        href: '/programme',
      },
    ]}
  >
    <Fragment slot="title">
      Retraites spirituelles en Suisse<br />
      <span class="text-accent-400">face aux Alpes</span>
    </Fragment>

    <Fragment slot="subtitle">
      Depuis 1970, le Foyer de Charité Dents-du-Midi accueille ceux qui cherchent le silence et la prière.
      Retraites de 1 à 6 jours dans un cadre exceptionnel à Bex, Suisse romande.
    </Fragment>

    <Fragment slot="bg">
      <div class="absolute inset-0">
        <img
          src="/images/hero-mountains.jpg"
          alt="Vue sur les Dents-du-Midi depuis le Foyer de Charité à Bex, Suisse"
          class="w-full h-full object-cover"
          loading="eager"
        />
        <div class="absolute inset-0 bg-primary-900/60"></div>
      </div>
    </Fragment>
  </Hero>

  <!-- Stats : Chiffres clés -->
  <Stats
    stats={[
      { title: 'ans d\'accueil', amount: '55+' },
      { title: 'retraites en 2026', amount: '20' },
      { title: 'par jour (suggéré)', amount: 'CHF 120' },
      { title: 'Foyer en Suisse', amount: 'Seul' },
    ]}
  />

  <!-- 6 Packages en cartes -->
  <Features2
    title="Nos retraites spirituelles"
    subtitle="Six formats adaptés à chaque besoin : de la journée découverte à la retraite de 6 jours"
    tagline="Nos offres"
    items={[
      {
        title: 'Retraites de 6 jours',
        description: 'Six jours pour cheminer dans le mystère de la foi. Silence, enseignements et accompagnement spirituel. Dès CHF 720.-',
        icon: 'tabler:sunset-2',
        callToAction: { text: 'En savoir plus', href: '/retraites/6-jours' },
      },
      {
        title: 'Week-ends 3 jours',
        description: 'Une pause au coeur de votre quotidien. Idéal pour une première retraite ou un temps liturgique fort. Dès CHF 360.-',
        icon: 'tabler:calendar-event',
        callToAction: { text: 'En savoir plus', href: '/retraites/week-end' },
      },
      {
        title: 'Couples',
        description: 'Donnez du souffle à votre couple. Accueil des enfants de 4 à 12 ans avec animation dédiée.',
        icon: 'tabler:hearts',
        callToAction: { text: 'En savoir plus', href: '/retraites/couples' },
      },
      {
        title: 'Familles',
        description: 'La foi en famille, une aventure. Programme adapté petits et grands, thématiques actuelles.',
        icon: 'tabler:home-heart',
        callToAction: { text: 'En savoir plus', href: '/retraites/familles' },
      },
      {
        title: 'Journées',
        description: 'Une halte de quelques heures : café, conférences, repas et Eucharistie. CHF 50.- tout compris.',
        icon: 'tabler:sun',
        callToAction: { text: 'En savoir plus', href: '/retraites/journees' },
      },
      {
        title: 'Préparation au mariage',
        description: 'Préparez votre mariage dans un cadre exceptionnel. CHF 200.- par couple, hébergement possible.',
        icon: 'tabler:rings',
        callToAction: { text: 'En savoir plus', href: '/retraites/preparation-mariage' },
      },
    ]}
  >
    <Fragment slot="bg">
      <div class="absolute inset-0 bg-surface-alt"></div>
    </Fragment>
  </Features2>

  <!-- Prochaines dates (dynamique) -->
  <Steps
    title="Prochaines retraites 2026"
    subtitle="Inscrivez-vous dès maintenant pour réserver votre place"
    items={stepsItems}
    callToAction={{
      text: 'Programme complet 2026',
      href: '/programme',
      icon: 'tabler:arrow-right',
    }}
  />

  <!-- Une retraite, c'est quoi ? -->
  <Content
    isReversed
    tagline="Découvrir"
    title="Une retraite, c'est quoi ?"
    items={[
      {
        title: 'Un temps de silence',
        description: 'Se retirer du bruit du quotidien pour retrouver l\'essentiel, dans un cadre de paix face aux montagnes.',
      },
      {
        title: 'Des enseignements',
        description: 'Deux conférences quotidiennes par des prédicateurs de qualité : prêtres, théologiens, couples animateurs.',
      },
      {
        title: 'Un accompagnement',
        description: 'Possibilité d\'accompagnement spirituel individuel. Eucharistie quotidienne. Temps de prière personnelle.',
      },
    ]}
    callToAction={{
      text: 'Découvrir nos retraites',
      href: '/retraites',
    }}
  >
    <Fragment slot="content">
      <h3 class="text-2xl font-bold tracking-tight sm:text-3xl mb-2 text-primary-600">
        Un lieu pour se retrouver
      </h3>
      Ce qui se vit dans ce Foyer est l'écho vivant et vibrant de la grâce de Dieu. La petite communauté accueille
      ceux qui, attirés par le Seigneur, éprouvent le besoin de s'arrêter, de réfléchir, de prier pour redonner
      vigueur et élan à leur métier de vivre.
    </Fragment>

    <Fragment slot="bg">
      <div class="absolute inset-0 bg-surface-special"></div>
    </Fragment>
  </Content>

  <!-- Le Foyer en bref -->
  <Content
    tagline="Le Foyer"
    title="Le seul Foyer de Charité en Suisse"
    items={[
      {
        title: 'Fondé en 1970',
        description: 'Plus de 55 ans d\'accueil et de retraites spirituelles dans le Chablais vaudois.',
      },
      {
        title: 'Un cadre exceptionnel',
        description: 'Ancien hôtel face aux Dents-du-Midi, 7 hectares de prairie et forêt, chapelle avec vue sur les Alpes.',
      },
      {
        title: 'Pension complète',
        description: 'Hébergement en chambres, cuisine maison, accueil chaleureux par la communauté du Foyer.',
      },
    ]}
    callToAction={{
      text: 'En savoir plus sur le Foyer',
      href: '/le-foyer',
    }}
  >
    <Fragment slot="content">
      <h3 class="text-2xl font-bold tracking-tight sm:text-3xl mb-2 text-primary-600">
        Bex, aux portes du Valais
      </h3>
      Un écrin de verdure face aux montagnes des Dents-du-Midi, à quelques kilomètres des rives du lac Léman.
      Un lieu qui ouvre aux profondeurs et donne saveur à la vie.
    </Fragment>
  </Content>

  <!-- Témoignages (dynamique) -->
  <Testimonials
    title="Ce qu'ils en disent"
    subtitle="Paroles de retraitants"
    tagline="Témoignages"
    testimonials={selectedTestimonials}
    callToAction={{
      text: 'Tous les témoignages',
      href: '/temoignages',
    }}
  />

  <!-- CTA bannière -->
  <CallToAction
    isDark
    actions={[
      {
        variant: 'primary',
        text: 'Réserver ma retraite',
        href: '/contact/inscription',
        icon: 'tabler:arrow-right',
      },
      {
        text: 'Voir le programme',
        href: '/programme',
      },
    ]}
  >
    <Fragment slot="title">
      Prenez le temps de <span class="text-accent-400">vous retrouver</span>
    </Fragment>

    <Fragment slot="subtitle">
      Retraites de 1 à 6 jours dans un cadre exceptionnel face aux Alpes.<br />
      Personne n'est refusé pour des raisons financières.
    </Fragment>

    <Fragment slot="bg">
      <div class="absolute inset-0 bg-primary-600"></div>
    </Fragment>
  </CallToAction>
</Layout>
