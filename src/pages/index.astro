---
import Layout from '~/layouts/PageLayout.astro';
import { getCollection } from 'astro:content';

import Hero from '~/components/widgets/Hero.astro';
import Features2 from '~/components/widgets/Features2.astro';
import Content from '~/components/widgets/Content.astro';
import Steps from '~/components/widgets/Steps.astro';
import Testimonials from '~/components/widgets/Testimonials.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import Stats from '~/components/widgets/Stats.astro';

import fddmChapelleTournesols from '~/assets/images/fddm-chapelle-tournesols.jpg';
import fddmTableeTerrasse from '~/assets/images/fddm-tablee-terrasse.jpg';

const metadata = {
  title: 'Retraites spirituelles en Suisse — Foyer de Charité Dents-du-Midi, Bex',
  ignoreTitleTemplate: true,
  description: 'Retraites spirituelles en Suisse romande de 1 à 6 jours face aux Alpes. Silence, enseignements, accompagnement spirituel. Le seul Foyer de Charité en Suisse, à Bex (VD).',
};

// --- Prochaines retraites (dynamique depuis la collection events) ---
const today = new Date().toISOString().split('T')[0]; // "YYYY-MM-DD"
const allEvents = await getCollection('event');
const upcomingEvents = allEvents
  .filter((e) => e.data.dateStart >= today)
  .sort((a, b) => a.data.dateStart.localeCompare(b.data.dateStart))
  .slice(0, 3);

const formatDate = (dateStr: string) => {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('fr-CH', { day: 'numeric', month: 'long' });
};

const formatDateRange = (start: string, end?: string) => {
  if (!end) return formatDate(start);
  const s = new Date(start + 'T12:00:00');
  const e = new Date(end + 'T12:00:00');
  if (s.getMonth() === e.getMonth()) {
    return `${s.getDate()}-${e.toLocaleDateString('fr-CH', { day: 'numeric', month: 'long' })}`;
  }
  return `${formatDate(start)} - ${formatDate(end)}`;
};

const stepsItems = [
  ...upcomingEvents.map((event) => ({
    title: `${formatDateRange(event.data.dateStart, event.data.dateEnd)} — <span class="font-medium">«${event.data.title}»</span>`,
    description: `${event.data.preacher}${event.data.variant ? ` · ${event.data.variant}` : ''}${event.data.price ? ` · ${event.data.price}` : ''}`,
    icon: 'tabler:calendar' as const,
  })),
  {
    title: 'Voir tout le programme',
    description: '',
    icon: 'tabler:arrow-right' as const,
  },
];

// --- Témoignages (dynamique depuis la collection testimonials) ---
const allTestimonials = await getCollection('testimonial');
const shuffled = [...allTestimonials].sort(() => Math.random() - 0.5);
const selectedTestimonials = shuffled.slice(0, 6).map((t) => ({
  testimonial: t.data.quote,
  name: t.data.name,
  job: t.data.retreatType || 'Retraitant(e)',
}));
---

<Layout metadata={metadata}>
  <!-- Hero : Vue Dents-du-Midi + Accroche -->
  <Hero
    actions={[
      {
        variant: 'primary',
        text: "S'inscrire à une retraite",
        href: '/contact/inscription',
        icon: 'tabler:arrow-right',
      },
      {
        text: 'Découvrir le programme',
        href: '/programme',
      },
    ]}
  >
    <Fragment slot="title">
      Un lieu de silence et de prière<br />
      <span class="text-accent-400">face aux Alpes</span>
    </Fragment>

    <Fragment slot="subtitle">
      Depuis 1970, le Foyer de Charité Dents-du-Midi accueille ceux qui éprouvent le besoin de s'arrêter.
      Retraites de 1 à 6 jours à Bex, au pied des montagnes.
    </Fragment>

    <Fragment slot="bg">
      <div class="absolute inset-0">
        <img
          src="/images/fddm-lune-dents-du-midi.jpg"
          alt="Pleine lune sur les Dents-du-Midi au coucher du soleil, alpenglow"
          class="w-full h-full object-cover"
          loading="eager"
        />
        <div class="absolute inset-0 bg-primary-900/60"></div>
      </div>
    </Fragment>
  </Hero>

  <!-- Stats : Chiffres clés -->
  <Stats
    stats={[
      { title: 'ans d\'accueil', amount: '55+' },
      { title: 'retraites en 2026', amount: '20' },
      { title: 'Foyers dans le monde', amount: '75' },
      { title: 'en Suisse', amount: 'Seul' },
    ]}
  />

  <!-- 6 Packages en cartes -->
  <Features2
    title="Plusieurs chemins, une même quête"
    subtitle="De la journée de découverte à la retraite de six jours, chacun trouve son pas."
    tagline="Nos retraites"
    items={[
      {
        title: 'Six jours de silence',
        description: 'Le format historique des Foyers de Charité. Six jours pour cheminer dans le mystère de la foi, portés par les enseignements et le silence.',
        icon: 'tabler:sunset-2',
        callToAction: { text: 'En savoir plus', href: '/retraites/6-jours' },
      },
      {
        title: 'Trois jours pour s\'arrêter',
        description: 'Une halte au cœur de votre quotidien. Idéal pour une première retraite ou pour vivre un temps fort de l\'année liturgique.',
        icon: 'tabler:calendar-event',
        callToAction: { text: 'En savoir plus', href: '/retraites/week-end' },
      },
      {
        title: 'En couple',
        description: 'Un temps à deux pour se retrouver dans la prière et le dialogue. Vos enfants sont accueillis avec un programme adapté à leur âge.',
        icon: 'tabler:hearts',
        callToAction: { text: 'En savoir plus', href: '/retraites/couples' },
      },
      {
        title: 'En famille',
        description: 'Vivre la foi ensemble, petits et grands. Des moments de partage et de prière adaptés à chaque âge.',
        icon: 'tabler:home-heart',
        callToAction: { text: 'En savoir plus', href: '/retraites/familles' },
      },
      {
        title: 'Une journée au Foyer',
        description: 'Quelques heures pour se poser : enseignements, repas partagé et Eucharistie. Une porte d\'entrée toute simple.',
        icon: 'tabler:sun',
        callToAction: { text: 'En savoir plus', href: '/retraites/journees' },
      },
      {
        title: 'Préparation au mariage',
        description: 'Deux jours pour préparer votre engagement, accompagnés par des couples expérimentés et un prêtre. En partenariat avec le Diocèse de Sion.',
        icon: 'tabler:rings',
        callToAction: { text: 'En savoir plus', href: '/retraites/preparation-mariage' },
      },
    ]}
  >
    <Fragment slot="bg">
      <div class="absolute inset-0 bg-surface-alt"></div>
    </Fragment>
  </Features2>

  <!-- Prochaines dates (dynamique) -->
  <Steps
    title="Prochaines retraites"
    subtitle="Les portes du Foyer sont ouvertes. Voici les prochaines dates."
    items={stepsItems}
    callToAction={{
      text: 'Programme complet 2026',
      href: '/programme',
      icon: 'tabler:arrow-right',
    }}
  />

  <!-- Une retraite, c'est quoi ? -->
  <Content
    isReversed
    tagline="Découvrir"
    title="Qu'est-ce qu'une retraite ?"
    image={{
      src: fddmChapelleTournesols,
      alt: 'Tabernacle fleuri de tournesols dans la chapelle du Foyer de Charité',
    }}
    items={[
      {
        title: 'Le silence',
        description: 'Se retirer du bruit du monde pour écouter ce qui se dit au fond de soi, face aux montagnes.',
      },
      {
        title: 'La Parole',
        description: 'Deux enseignements par jour, donnés par des prédicateurs qui ouvrent les Écritures et nourrissent la réflexion.',
      },
      {
        title: 'L\'accompagnement',
        description: 'Un entretien personnel si vous le souhaitez. L\'Eucharistie quotidienne. Un temps pour prier à votre rythme.',
      },
    ]}
    callToAction={{
      text: 'Découvrir nos retraites',
      href: '/retraites',
    }}
  >
    <Fragment slot="content">
      <h3 class="text-2xl font-bold tracking-tight sm:text-3xl mb-2 text-primary-600">
        Un lieu pour se retrouver
      </h3>
      Ce qui se vit dans ce Foyer est l'écho vivant et vibrant de la grâce de Dieu. La petite communauté accueille
      ceux qui, attirés par le Seigneur, éprouvent le besoin de s'arrêter, de réfléchir, de prier pour redonner
      vigueur et élan à leur métier de vivre.
    </Fragment>

    <Fragment slot="bg">
      <div class="absolute inset-0 bg-surface-special"></div>
    </Fragment>
  </Content>

  <!-- Le Foyer en bref -->
  <Content
    tagline="Le Foyer"
    title="Le seul Foyer de Charité en Suisse"
    image={{
      src: fddmTableeTerrasse,
      alt: 'Grande tablée en terrasse du Foyer, repas partagé avec vue sur les montagnes',
    }}
    items={[
      {
        title: 'Fondé en 1970',
        description: 'Plus de 55 ans d\'accueil au pied des Dents-du-Midi. Le seul Foyer de Charité en Suisse.',
      },
      {
        title: 'Un lieu habité',
        description: 'Sept hectares de prairie et de forêt, une chapelle face aux Alpes, et une communauté qui prie et qui accueille.',
      },
      {
        title: 'Tout est prévu',
        description: 'Vous êtes reçus en pension : chambre, repas préparés par la communauté, et la liberté de ne penser à rien d\'autre qu\'à l\'essentiel.',
      },
    ]}
    callToAction={{
      text: 'En savoir plus sur le Foyer',
      href: '/le-foyer',
    }}
  >
    <Fragment slot="content">
      <h3 class="text-2xl font-bold tracking-tight sm:text-3xl mb-2 text-primary-600">
        Bex, aux portes du Valais
      </h3>
      Un écrin de verdure face aux montagnes des Dents-du-Midi, à quelques kilomètres des rives du lac Léman.
      Un lieu qui ouvre aux profondeurs et donne saveur à la vie.
    </Fragment>
  </Content>

  <!-- Témoignages (dynamique) -->
  <Testimonials
    title="Paroles de retraitants"
    subtitle="Ce qui se vit ici ne s'explique pas toujours. Parfois, ce sont ceux qui l'ont vécu qui en parlent le mieux."
    tagline="Témoignages"
    testimonials={selectedTestimonials}
    callToAction={{
      text: 'Tous les témoignages',
      href: '/temoignages',
    }}
  />

  <!-- CTA bannière -->
  <CallToAction
    isDark
    actions={[
      {
        variant: 'primary',
        text: 'S\'inscrire à une retraite',
        href: '/contact/inscription',
        icon: 'tabler:arrow-right',
      },
      {
        text: 'Découvrir le programme',
        href: '/programme',
      },
    ]}
  >
    <Fragment slot="title">
      Prenez le temps de <span class="text-accent-400">vous retrouver</span>
    </Fragment>

    <Fragment slot="subtitle">
      Le Foyer vous accueille pour une retraite de 1 à 6 jours, au pied des Alpes.<br />
      Aucune situation financière ne doit être un obstacle.
    </Fragment>

    <Fragment slot="bg">
      <div class="absolute inset-0 bg-primary-600"></div>
    </Fragment>
  </CallToAction>
</Layout>
