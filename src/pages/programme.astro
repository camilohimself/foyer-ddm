---
import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import { getCollection } from 'astro:content';

const allEvents = await getCollection('event');
const events = allEvents.sort((a, b) => a.data.dateStart.localeCompare(b.data.dateStart));

const metadata = {
  title: 'Programme des retraites spirituelles 2026',
  description: `${events.length} retraites spirituelles en Suisse au Foyer de Charité Dents-du-Midi, Bex. Retraites de 6 jours, week-ends, journées, couples, familles. Calendrier complet.`,
};

// --- Mapping type → badge + label ---
const typeBadge: Record<string, { badge: string; label: string }> = {
  '6-jours': { badge: 'bg-primary-600', label: '6 jours' },
  'week-end': { badge: 'bg-primary-600', label: '3 jours' },
  couples: { badge: 'bg-rose-500', label: 'Couples' },
  familles: { badge: 'bg-emerald-500', label: 'Familles' },
  journees: { badge: 'bg-accent-400', label: 'Journée' },
  mariage: { badge: 'bg-purple-500', label: 'Mariage' },
};

// --- Date formatting ---
const formatDate = (dateStr: string) => {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('fr-CH', { day: 'numeric', month: 'long' });
};

const formatDateRange = (start: string, end?: string) => {
  if (!end) return formatDate(start);
  const s = new Date(start + 'T12:00:00');
  const e = new Date(end + 'T12:00:00');
  if (s.getMonth() === e.getMonth()) {
    return `${s.getDate()}-${e.toLocaleDateString('fr-CH', { day: 'numeric', month: 'long' })}`;
  }
  return `${formatDate(start)} - ${formatDate(end)}`;
};

// --- JSON-LD events data ---
const jsonLdEvents = events.map((event) => ({
  name: event.data.title,
  startDate: event.data.dateStart,
  endDate: event.data.dateEnd,
  description: `${typeBadge[event.data.type]?.label || event.data.type} — ${event.data.preacher}`,
  price: event.data.price,
  performer: event.data.preacher,
}));

// --- Detect past events ---
const today = new Date().toISOString().split('T')[0];
---

<Layout metadata={metadata}>
  <!-- JSON-LD Event schemas (Google lit le ld+json n'importe où dans la page) -->
  {jsonLdEvents.map((event) => (
    <script type="application/ld+json" set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'Event',
      name: event.name,
      startDate: event.startDate,
      endDate: event.endDate || event.startDate,
      description: event.description || 'Retraite spirituelle au Foyer de Charité Dents-du-Midi, Bex, Suisse.',
      eventAttendanceMode: 'https://schema.org/OfflineEventAttendanceMode',
      eventStatus: 'https://schema.org/EventScheduled',
      location: {
        '@type': 'Place',
        name: 'Foyer de Charité Dents-du-Midi',
        address: { '@type': 'PostalAddress', streetAddress: 'Route de Gryon 22', addressLocality: 'Bex', postalCode: '1880', addressCountry: 'CH' },
      },
      organizer: { '@type': 'Organization', name: 'Foyer de Charité Dents-du-Midi', url: 'https://foyer-dents-du-midi.ch' },
      ...(event.performer ? { performer: { '@type': 'Person', name: event.performer } } : {}),
      ...(event.price ? { offers: { '@type': 'Offer', price: event.price.replace(/[^0-9.]/g, ''), priceCurrency: 'CHF', url: 'https://foyer-dents-du-midi.ch/contact/inscription', availability: 'https://schema.org/InStock' } } : {}),
      image: 'https://foyer-dents-du-midi.ch/images/hero-mountains.jpg',
    })} />
  ))}

  <Hero>
    <Fragment slot="title">
      Retraites spirituelles <span class="text-accent-400">2026</span>
    </Fragment>
    <Fragment slot="subtitle">
      {events.length} retraites de février à septembre au Foyer de Charité Dents-du-Midi, Bex.
      Retraites de 6 jours, week-ends, journées, couples, familles et préparation au mariage.
    </Fragment>
    <Fragment slot="bg">
      <div class="absolute inset-0">
        <img
          src="/images/fddm-dents-du-midi-printemps.jpg"
          alt="Les Dents-du-Midi au printemps, programme des retraites 2026"
          class="w-full h-full object-cover"
          loading="eager"
        />
        <div class="absolute inset-0 bg-primary-900/60"></div>
      </div>
    </Fragment>
  </Hero>

  <section class="py-12 md:py-20">
    <div class="max-w-5xl mx-auto px-4 sm:px-6">
      <!-- Légende badges -->
      <div class="flex flex-wrap gap-3 mb-8 justify-center">
        <span class="inline-flex items-center gap-1.5 text-sm"><span class="w-3 h-3 rounded-full bg-primary-600"></span> 6 jours / 3 jours</span>
        <span class="inline-flex items-center gap-1.5 text-sm"><span class="w-3 h-3 rounded-full bg-accent-400"></span> Journée</span>
        <span class="inline-flex items-center gap-1.5 text-sm"><span class="w-3 h-3 rounded-full bg-rose-500"></span> Couples</span>
        <span class="inline-flex items-center gap-1.5 text-sm"><span class="w-3 h-3 rounded-full bg-emerald-500"></span> Familles</span>
        <span class="inline-flex items-center gap-1.5 text-sm"><span class="w-3 h-3 rounded-full bg-purple-500"></span> Mariage</span>
      </div>

      <!-- Liste événements -->
      <div class="space-y-4">
        {events.map((event) => {
          const isPast = (event.data.dateEnd || event.data.dateStart) < today;
          const info = typeBadge[event.data.type] || { badge: 'bg-gray-500', label: event.data.type };
          return (
            <div class={`flex flex-col sm:flex-row gap-4 p-5 rounded-lg border border-gray-200 hover:shadow-md transition-shadow bg-white ${isPast ? 'opacity-50' : ''}`}>
              <div class="sm:w-44 shrink-0">
                <div class="text-sm font-semibold text-primary-600">
                  {formatDateRange(event.data.dateStart, event.data.dateEnd)}
                </div>
                <span class={`inline-block mt-1 text-xs font-medium text-white px-2.5 py-0.5 rounded-full ${info.badge}`}>
                  {info.label}
                </span>
                {isPast && <span class="inline-block ml-1 text-xs text-gray-400">(passée)</span>}
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-primary-600">{event.data.title}</h3>
                <p class="text-sm text-muted mt-1">
                  {event.data.preacher}
                  {event.data.variant && <span class="ml-2 text-accent-500 font-medium">· {event.data.variant}</span>}
                  {event.data.price && <span class="ml-2 text-gray-500">· {event.data.price}</span>}
                </p>
              </div>
              <div class="sm:self-center shrink-0">
                {isPast ? (
                  <span class="inline-flex items-center justify-center text-sm font-medium text-gray-400 px-4 py-2">Terminée</span>
                ) : (
                  <a
                    href="/contact/inscription"
                    class="inline-flex items-center justify-center text-sm font-semibold bg-accent-400 text-white px-4 py-2 rounded-full hover:bg-accent-300 transition"
                  >
                    S'inscrire
                  </a>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </section>

  <CallToAction
    isDark
    actions={[
      {
        variant: 'primary',
        text: "S'inscrire à une retraite",
        href: '/contact/inscription',
        icon: 'tabler:arrow-right',
      },
      {
        text: 'Nous contacter',
        href: '/contact',
      },
    ]}
  >
    <Fragment slot="title">
      Réservez votre <span class="text-accent-400">retraite spirituelle</span>
    </Fragment>
    <Fragment slot="subtitle">
      Les places sont limitées. Inscrivez-vous dès maintenant pour réserver votre place.<br />
      Personne n'est refusé pour des raisons financières.
    </Fragment>
    <Fragment slot="bg">
      <div class="absolute inset-0 bg-primary-600"></div>
    </Fragment>
  </CallToAction>
</Layout>
