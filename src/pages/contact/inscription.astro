---
import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import { getCollection } from 'astro:content';

const metadata = {
  title: "S'inscrire √† une retraite",
  description: "Remplissez le formulaire d'inscription en 3 √©tapes. Vous recevrez une confirmation par email sous 48h.",
};

// TODO:OASIS ‚Äî Remplacer par GET /api/events quand l'API sera disponible
const allEvents = await getCollection('event');
const events = allEvents
  .filter((e) => e.data.registrationOpen)
  .sort((a, b) => a.data.dateStart.localeCompare(b.data.dateStart));

function formatDate(dateStr: string): string {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('fr-CH', { day: 'numeric', month: 'long' });
}

function formatEventLabel(event: (typeof events)[0]): string {
  const start = formatDate(event.data.dateStart);
  const end = event.data.dateEnd ? formatDate(event.data.dateEnd) : '';
  const dateRange = end ? `${start} ‚Äì ${end}` : start;
  const variant = event.data.variant ? ` (${event.data.variant})` : '';
  return `${dateRange} ‚Äî ¬´${event.data.title}¬ª${variant}`;
}
---

<Layout metadata={metadata}>
  <Hero
    tagline="Inscription"
    title="S'inscrire √† une retraite"
    subtitle="Compl√©tez votre inscription en 3 √©tapes simples. Vous recevrez une confirmation par email sous 48h."
  >
    <Fragment slot="bg">
      <div class="absolute inset-0">
        <img
          src="/images/fddm-raquettes-dents-du-midi.jpg"
          alt="Groupe de retraitants en raquettes face aux Dents-du-Midi enneig√©es"
          class="w-full h-full object-cover"
          loading="eager"
        />
        <div class="absolute inset-0 bg-primary-900/60"></div>
      </div>
    </Fragment>
  </Hero>

  <section class="px-4 py-16 sm:px-6 mx-auto lg:px-8 lg:py-20 max-w-4xl">

    <!-- Progress Bar -->
    <div class="mb-12" id="wizard-progress">
      <div class="flex items-center justify-center max-w-md mx-auto">
        <!-- Step 1 -->
        <div class="flex flex-col items-center">
          <div
            id="progress-circle-1"
            class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all duration-300 bg-accent-400 text-white shadow-md shadow-accent-400/30"
          >1</div>
          <span class="text-xs mt-2 font-medium text-accent-400" id="progress-label-1">Retraite</span>
        </div>
        <!-- Line 1-2 -->
        <div class="flex-1 h-0.5 mx-3 bg-gray-200 transition-all duration-300" id="progress-line-1"></div>
        <!-- Step 2 -->
        <div class="flex flex-col items-center">
          <div
            id="progress-circle-2"
            class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all duration-300 bg-gray-200 text-gray-500"
          >2</div>
          <span class="text-xs mt-2 font-medium text-gray-400" id="progress-label-2">Vos infos</span>
        </div>
        <!-- Line 2-3 -->
        <div class="flex-1 h-0.5 mx-3 bg-gray-200 transition-all duration-300" id="progress-line-2"></div>
        <!-- Step 3 -->
        <div class="flex flex-col items-center">
          <div
            id="progress-circle-3"
            class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all duration-300 bg-gray-200 text-gray-500"
          >3</div>
          <span class="text-xs mt-2 font-medium text-gray-400" id="progress-label-3">Confirmation</span>
        </div>
      </div>
    </div>

    <!-- Single form wrapping all steps (Netlify Forms compatibility) -->
    <form
      name="inscription"
      method="POST"
      data-netlify="true"
      netlify-honeypot="bot-field"
      id="wizard-form"
      class="bg-white shadow-xl rounded-2xl p-8 md:p-12"
    >
      <input type="hidden" name="form-name" value="inscription" />
      <p class="hidden">
        <label>Don't fill this out if you're human: <input name="bot-field" /></label>
      </p>

      <!-- ============================================ -->
      <!-- STEP 1 ‚Äî Retraite & Profil                  -->
      <!-- ============================================ -->
      <div id="wizard-step-1" class="wizard-step active" data-step="1">
        <h2 class="text-2xl font-bold text-primary-600 mb-2">Choisissez votre retraite</h2>
        <p class="text-muted mb-8">S√©lectionnez la retraite et indiquez votre profil de participant.</p>

        <!-- Retraite -->
        <div class="mb-6">
          <label for="retraite" class="block text-sm font-medium text-primary-600 mb-2">
            Retraite <span class="text-accent-400">*</span>
          </label>
          <select
            id="retraite"
            name="retraite"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
          >
            <option value="">S√©lectionnez une retraite</option>
            {events.map((event) => (
              <option value={event.id}>{formatEventLabel(event)}</option>
            ))}
          </select>
        </div>

        <!-- Type participant ‚Äî radio cards -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-primary-600 mb-3">
            Type de participant <span class="text-accent-400">*</span>
          </label>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="radio-card">
              <input type="radio" id="type-individuel" name="type-participant" value="Individuel" required class="sr-only" />
              <label for="type-individuel" class="block border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-accent-300 transition-all">
                <span class="block text-2xl mb-1">üôã</span>
                <span class="text-sm font-medium text-primary-600">Individuel</span>
              </label>
            </div>
            <div class="radio-card">
              <input type="radio" id="type-couple" name="type-participant" value="Couple" class="sr-only" />
              <label for="type-couple" class="block border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-accent-300 transition-all">
                <span class="block text-2xl mb-1">üíë</span>
                <span class="text-sm font-medium text-primary-600">Couple</span>
              </label>
            </div>
            <div class="radio-card">
              <input type="radio" id="type-famille" name="type-participant" value="Famille" class="sr-only" />
              <label for="type-famille" class="block border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-accent-300 transition-all">
                <span class="block text-2xl mb-1">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                <span class="text-sm font-medium text-primary-600">Famille</span>
              </label>
            </div>
            <div class="radio-card">
              <input type="radio" id="type-enfants" name="type-participant" value="Enfant(s) seul(s)" class="sr-only" />
              <label for="type-enfants" class="block border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-accent-300 transition-all">
                <span class="block text-2xl mb-1">üë¶</span>
                <span class="text-sm font-medium text-primary-600">Enfant(s)</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Nombre adultes -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label for="nombre-adultes" class="block text-sm font-medium text-primary-600 mb-2">
              Nombre d'adultes <span class="text-accent-400">*</span>
            </label>
            <input
              type="number"
              id="nombre-adultes"
              name="nombre-adultes"
              min="1"
              max="10"
              value="1"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
            />
          </div>
          <!-- Nombre enfants (conditionnel) -->
          <div id="enfants-wrapper" class="hidden">
            <label for="nombre-enfants" class="block text-sm font-medium text-primary-600 mb-2">
              Nombre d'enfants
            </label>
            <input
              type="number"
              id="nombre-enfants"
              name="nombre-enfants"
              min="0"
              max="10"
              value="0"
              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
            />
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- STEP 2 ‚Äî Informations personnelles           -->
      <!-- ============================================ -->
      <div id="wizard-step-2" class="wizard-step" data-step="2">
        <h2 class="text-2xl font-bold text-primary-600 mb-2">Vos informations</h2>
        <p class="text-muted mb-8">Renseignez vos coordonn√©es et pr√©f√©rences pour votre retraite.</p>

        <!-- Pr√©nom / Nom -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label for="prenom" class="block text-sm font-medium text-primary-600 mb-2">
              Pr√©nom <span class="text-accent-400">*</span>
            </label>
            <input
              type="text"
              id="prenom"
              name="prenom"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
              placeholder="Votre pr√©nom"
            />
          </div>
          <div>
            <label for="nom" class="block text-sm font-medium text-primary-600 mb-2">
              Nom <span class="text-accent-400">*</span>
            </label>
            <input
              type="text"
              id="nom"
              name="nom"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
              placeholder="Votre nom"
            />
          </div>
        </div>

        <!-- Email / T√©l√©phone -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label for="email" class="block text-sm font-medium text-primary-600 mb-2">
              Email <span class="text-accent-400">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
              placeholder="votre.email@exemple.ch"
            />
          </div>
          <div>
            <label for="telephone" class="block text-sm font-medium text-primary-600 mb-2">
              T√©l√©phone <span class="text-accent-400">*</span>
            </label>
            <input
              type="tel"
              id="telephone"
              name="telephone"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
              placeholder="+41 XX XXX XX XX"
            />
          </div>
        </div>

        <!-- Adresse / NPA Ville -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label for="adresse" class="block text-sm font-medium text-primary-600 mb-2">
              Adresse
            </label>
            <input
              type="text"
              id="adresse"
              name="adresse"
              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
              placeholder="Rue et num√©ro"
            />
          </div>
          <div>
            <label for="npa-ville" class="block text-sm font-medium text-primary-600 mb-2">
              NPA / Ville
            </label>
            <input
              type="text"
              id="npa-ville"
              name="npa-ville"
              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
              placeholder="1880 Bex"
            />
          </div>
        </div>

        <!-- H√©bergement ‚Äî radio cards -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-primary-600 mb-3">
            H√©bergement <span class="text-accent-400">*</span>
          </label>
          <div class="grid grid-cols-2 gap-3">
            <div class="radio-card">
              <input type="radio" id="chambre-individuelle" name="hebergement" value="Chambre individuelle" required class="sr-only" />
              <label for="chambre-individuelle" class="block border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-accent-300 transition-all">
                <span class="block text-xl mb-1">üõèÔ∏è</span>
                <span class="text-sm font-medium text-primary-600">Individuelle</span>
              </label>
            </div>
            <div class="radio-card">
              <input type="radio" id="chambre-double" name="hebergement" value="Chambre double" class="sr-only" />
              <label for="chambre-double" class="block border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-accent-300 transition-all">
                <span class="block text-xl mb-1">üõèÔ∏èüõèÔ∏è</span>
                <span class="text-sm font-medium text-primary-600">Double</span>
              </label>
            </div>
          </div>
        </div>

        <!-- R√©gime alimentaire -->
        <div class="mb-6">
          <label for="regime" class="block text-sm font-medium text-primary-600 mb-2">
            R√©gime alimentaire
          </label>
          <select
            id="regime"
            name="regime"
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
          >
            <option value="Aucun">Aucun r√©gime particulier</option>
            <option value="Sans gluten">Sans gluten</option>
            <option value="Sans lactose">Sans lactose</option>
            <option value="V√©g√©tarien">V√©g√©tarien</option>
            <option value="Autre">Autre (pr√©cisez dans le message)</option>
          </select>
        </div>

        <!-- Comment connu -->
        <div class="mb-6">
          <label for="comment-connu" class="block text-sm font-medium text-primary-600 mb-2">
            Comment avez-vous connu le Foyer ?
          </label>
          <select
            id="comment-connu"
            name="comment-connu"
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
          >
            <option value="">‚Äî</option>
            <option value="Bouche √† oreille">Bouche √† oreille</option>
            <option value="Paroisse">Paroisse</option>
            <option value="R√©seaux sociaux">R√©seaux sociaux</option>
            <option value="Internet">Internet / recherche</option>
            <option value="Brochure">Brochure / flyer</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <!-- Mode d'arriv√©e -->
        <div class="mb-6">
          <label for="mode-arrivee" class="block text-sm font-medium text-primary-600 mb-2">
            Mode d'arriv√©e
          </label>
          <select
            id="mode-arrivee"
            name="mode-arrivee"
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
          >
            <option value="Propres moyens">Propres moyens</option>
            <option value="Transports publics">Transports publics</option>
            <option value="Covoiturage">Covoiturage souhait√©</option>
          </select>
        </div>

        <!-- Autorisation photos -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-primary-600 mb-3">
            Autorisation photos / vid√©os
          </label>
          <div class="flex gap-6">
            <div class="flex items-center">
              <input type="radio" id="photos-oui" name="autorisation-photos" value="Oui" class="w-4 h-4 text-accent-400 focus:ring-accent-400" />
              <label for="photos-oui" class="ml-2 text-sm text-gray-700">Oui, j'autorise</label>
            </div>
            <div class="flex items-center">
              <input type="radio" id="photos-non" name="autorisation-photos" value="Non" class="w-4 h-4 text-accent-400 focus:ring-accent-400" />
              <label for="photos-non" class="ml-2 text-sm text-gray-700">Non</label>
            </div>
          </div>
        </div>

        <!-- Message -->
        <div>
          <label for="message" class="block text-sm font-medium text-primary-600 mb-2">
            Message libre
          </label>
          <textarea
            id="message"
            name="message"
            rows="4"
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-accent-400 focus:border-transparent focus:shadow-lg focus:shadow-accent-400/10 transition-shadow"
            placeholder="Questions, besoins sp√©cifiques, pr√©cisions..."
          ></textarea>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- STEP 3 ‚Äî R√©capitulatif & Confirmation        -->
      <!-- ============================================ -->
      <div id="wizard-step-3" class="wizard-step" data-step="3">
        <h2 class="text-2xl font-bold text-primary-600 mb-2">R√©capitulatif</h2>
        <p class="text-muted mb-8">V√©rifiez vos informations avant de confirmer votre inscription.</p>

        <!-- Recap container (populated by JS via safe DOM methods) -->
        <div id="recap-content" class="mb-8 rounded-xl border border-gray-200 overflow-hidden">
        </div>

        <!-- RGPD -->
        <div class="space-y-4 mb-8">
          <div class="flex items-start">
            <input
              type="checkbox"
              id="rgpd"
              name="rgpd"
              required
              class="mt-1 w-4 h-4 text-accent-400 focus:ring-accent-400 rounded"
            />
            <label for="rgpd" class="ml-3 text-sm text-gray-700">
              J'accepte que mes donn√©es personnelles soient trait√©es dans le cadre de cette inscription, conform√©ment au RGPD.
              Elles ne seront pas transmises √† des tiers. <span class="text-accent-400">*</span>
            </label>
          </div>

          <div class="flex items-start">
            <input
              type="checkbox"
              id="conditions"
              name="conditions"
              required
              class="mt-1 w-4 h-4 text-accent-400 focus:ring-accent-400 rounded"
            />
            <label for="conditions" class="ml-3 text-sm text-gray-700">
              J'accepte les conditions de la retraite et comprends que mon inscription sera confirm√©e par email sous 48h.
              <span class="text-accent-400">*</span>
            </label>
          </div>
        </div>

        <p class="text-xs text-gray-500 mb-6">
          Vos donn√©es personnelles sont utilis√©es uniquement pour le traitement de votre inscription et la gestion de votre inscription au Foyer de Charit√© des Dents-du-Midi.
        </p>
      </div>

      <!-- ============================================ -->
      <!-- Navigation buttons                           -->
      <!-- ============================================ -->
      <div class="flex justify-between items-center mt-10 pt-6 border-t border-gray-100">
        <button
          type="button"
          id="btn-prev"
          class="hidden px-6 py-3 rounded-xl border border-gray-300 text-primary-600 font-medium hover:bg-gray-50 transition-colors"
        >
          ‚Üê Pr√©c√©dent
        </button>

        <div class="ml-auto">
          <button
            type="button"
            id="btn-next"
            class="px-8 py-3 rounded-xl bg-accent-400 text-white font-semibold shadow-lg shadow-accent-400/30 hover:-translate-y-0.5 hover:shadow-xl hover:shadow-accent-400/40 transition-all duration-200"
          >
            Suivant ‚Üí
          </button>

          <button
            type="submit"
            id="btn-submit"
            class="hidden px-8 py-3 rounded-xl bg-accent-400 text-white font-semibold shadow-lg shadow-accent-400/30 hover:-translate-y-0.5 hover:shadow-xl hover:shadow-accent-400/40 transition-all duration-200"
          >
            Confirmer mon inscription
          </button>
        </div>
      </div>

      <p class="text-xs text-gray-500 text-center mt-6">
        <span class="text-accent-400">*</span> Champs obligatoires
      </p>
    </form>
  </section>
</Layout>

<script is:inline>
(function initWizard() {
  var TOTAL_STEPS = 3;
  var state = { currentStep: 1 };

  var steps = [];
  for (var i = 1; i <= TOTAL_STEPS; i++) {
    steps[i] = document.getElementById('wizard-step-' + i);
  }

  var btnPrev = document.getElementById('btn-prev');
  var btnNext = document.getElementById('btn-next');
  var btnSubmit = document.getElementById('btn-submit');

  // --- Progress bar update ---
  function updateProgress(step) {
    for (var i = 1; i <= TOTAL_STEPS; i++) {
      var circle = document.getElementById('progress-circle-' + i);
      var label = document.getElementById('progress-label-' + i);
      var line = i < TOTAL_STEPS ? document.getElementById('progress-line-' + i) : null;

      if (i < step) {
        circle.className = 'w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all duration-300 bg-primary-600 text-white';
        circle.textContent = '\u2713';
        label.className = 'text-xs mt-2 font-medium text-primary-600';
        if (line) line.className = 'flex-1 h-0.5 mx-3 transition-all duration-300 bg-primary-600';
      } else if (i === step) {
        circle.className = 'w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all duration-300 bg-accent-400 text-white shadow-md shadow-accent-400/30';
        circle.textContent = i;
        label.className = 'text-xs mt-2 font-medium text-accent-400';
        if (line) line.className = 'flex-1 h-0.5 mx-3 transition-all duration-300 bg-gray-200';
      } else {
        circle.className = 'w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all duration-300 bg-gray-200 text-gray-500';
        circle.textContent = i;
        label.className = 'text-xs mt-2 font-medium text-gray-400';
        if (line) line.className = 'flex-1 h-0.5 mx-3 transition-all duration-300 bg-gray-200';
      }
    }
  }

  // --- Show step ---
  function goToStep(n) {
    if (n < 1 || n > TOTAL_STEPS) return;

    var current = steps[state.currentStep];
    current.classList.remove('active');

    state.currentStep = n;
    var target = steps[n];
    target.classList.add('active');

    btnPrev.classList.toggle('hidden', n === 1);
    btnNext.classList.toggle('hidden', n === TOTAL_STEPS);
    btnSubmit.classList.toggle('hidden', n !== TOTAL_STEPS);

    updateProgress(n);

    document.getElementById('wizard-progress').scrollIntoView({ behavior: 'smooth', block: 'start' });

    if (n === TOTAL_STEPS) buildRecap();
  }

  // --- Validation ---
  function validateStep(n) {
    var stepEl = steps[n];
    var requiredFields = stepEl.querySelectorAll('[required]');
    var valid = true;

    // Clear previous errors
    stepEl.querySelectorAll('.wizard-error').forEach(function(el) { el.remove(); });
    stepEl.querySelectorAll('.border-red-400').forEach(function(el) {
      el.classList.remove('border-red-400', 'ring-2', 'ring-red-200');
    });

    var checkedRadioGroups = {};

    requiredFields.forEach(function(field) {
      if (field.type === 'radio') {
        if (checkedRadioGroups[field.name]) return;
        checkedRadioGroups[field.name] = true;

        var group = stepEl.querySelectorAll('input[name="' + field.name + '"]');
        var anyChecked = false;
        group.forEach(function(r) { if (r.checked) anyChecked = true; });
        if (!anyChecked) {
          valid = false;
          var wrapper = field.closest('.mb-6');
          if (wrapper && !wrapper.querySelector('.wizard-error')) {
            var err = document.createElement('p');
            err.className = 'wizard-error text-red-500 text-sm mt-2';
            err.textContent = 'Veuillez faire un choix.';
            wrapper.appendChild(err);
          }
        }
      } else if (field.type === 'checkbox') {
        if (!field.checked) {
          valid = false;
          field.classList.add('border-red-400', 'ring-2', 'ring-red-200');
          var parent = field.closest('.flex');
          if (parent && !parent.querySelector('.wizard-error')) {
            var err = document.createElement('p');
            err.className = 'wizard-error text-red-500 text-sm mt-1';
            err.textContent = 'Ce champ est obligatoire.';
            parent.appendChild(err);
          }
        }
      } else if (!field.checkValidity()) {
        valid = false;
        field.classList.add('border-red-400', 'ring-2', 'ring-red-200');
        var err = document.createElement('p');
        err.className = 'wizard-error text-red-500 text-sm mt-1';
        err.textContent = field.validationMessage || 'Ce champ est obligatoire.';
        field.parentNode.appendChild(err);
      }
    });

    return valid;
  }

  // --- Build recap with safe DOM methods ---
  var fieldLabels = {
    'retraite': 'Retraite',
    'type-participant': 'Type de participant',
    'nombre-adultes': "Nombre d'adultes",
    'nombre-enfants': "Nombre d'enfants",
    'prenom': 'Pr√©nom',
    'nom': 'Nom',
    'email': 'Email',
    'telephone': 'T√©l√©phone',
    'adresse': 'Adresse',
    'npa-ville': 'NPA / Ville',
    'hebergement': 'H√©bergement',
    'regime': 'R√©gime alimentaire',
    'comment-connu': 'Comment connu',
    'mode-arrivee': "Mode d'arriv√©e",
    'autorisation-photos': 'Autorisation photos',
    'message': 'Message'
  };

  var fieldOrder = [
    'retraite', 'type-participant', 'nombre-adultes', 'nombre-enfants',
    'prenom', 'nom', 'email', 'telephone', 'adresse', 'npa-ville',
    'hebergement', 'regime', 'comment-connu', 'mode-arrivee', 'autorisation-photos', 'message'
  ];

  function getDisplayValue(name, value) {
    if (name === 'retraite') {
      var select = document.getElementById('retraite');
      var opt = select.options[select.selectedIndex];
      return opt ? opt.textContent : value;
    }
    return value;
  }

  function buildRecap() {
    var form = document.getElementById('wizard-form');
    var container = document.getElementById('recap-content');

    // Clear previous content safely
    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }

    var dl = document.createElement('dl');
    var even = false;

    fieldOrder.forEach(function(name) {
      var value = '';
      var el = form.elements[name];
      if (!el) return;

      if (el.value !== undefined) {
        value = el.value;
      }

      // Skip empty optional fields
      if (!value || value === '') {
        return;
      }

      // Skip nombre-enfants if hidden
      if (name === 'nombre-enfants') {
        var wrapper = document.getElementById('enfants-wrapper');
        if (wrapper && wrapper.classList.contains('hidden')) return;
        if (value === '0') return;
      }

      var displayValue = getDisplayValue(name, value);
      var labelText = fieldLabels[name] || name;

      var row = document.createElement('div');
      row.className = 'flex flex-col sm:flex-row sm:justify-between px-5 py-3 border-b border-gray-100' + (even ? ' bg-gray-50' : '');

      var dt = document.createElement('dt');
      dt.className = 'text-sm font-medium text-primary-600';
      dt.textContent = labelText;

      var dd = document.createElement('dd');
      dd.className = 'text-sm text-gray-700 sm:text-right mt-1 sm:mt-0';
      dd.textContent = displayValue;

      row.appendChild(dt);
      row.appendChild(dd);
      dl.appendChild(row);

      even = !even;
    });

    container.appendChild(dl);
  }

  // --- Conditional fields (enfants) ---
  function handleConditionalFields() {
    var typeRadios = document.querySelectorAll('input[name="type-participant"]');
    var enfantsWrapper = document.getElementById('enfants-wrapper');

    typeRadios.forEach(function(radio) {
      radio.addEventListener('change', function() {
        var val = this.value;
        if (val === 'Famille' || val === 'Enfant(s) seul(s)') {
          enfantsWrapper.classList.remove('hidden');
        } else {
          enfantsWrapper.classList.add('hidden');
          document.getElementById('nombre-enfants').value = '0';
        }
      });
    });
  }

  // --- Event listeners ---
  btnNext.addEventListener('click', function() {
    if (validateStep(state.currentStep)) {
      goToStep(state.currentStep + 1);
    }
  });

  btnPrev.addEventListener('click', function() {
    goToStep(state.currentStep - 1);
  });

  document.getElementById('wizard-form').addEventListener('submit', function(e) {
    if (!validateStep(3)) {
      e.preventDefault();
    }
    // TODO:OASIS ‚Äî Intercepter ici pour POST /api/inscriptions au lieu de Netlify Forms
  });

  // Init
  handleConditionalFields();
  updateProgress(1);

  // View Transitions compat
  document.addEventListener('astro:after-swap', initWizard);
})();
</script>
